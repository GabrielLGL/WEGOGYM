# Code Review ‚Äî 20260220-2145

> Review r√©trospective des 3 derniers commits (working tree propre, tout d√©j√† push√©)

## Commits analys√©s
- `b473e24` ‚Äî style(components): replace magic numbers with theme tokens in 8 components
- `d974e11` ‚Äî fix(components): AlertDialog onError haptic + debounce inputs + clamping targets
- `4680d1e` ‚Äî fix(aiService+AssistantScreen): date filter on perfLogs + remove forceUpdate hack

## Fichiers analys√©s

| Fichier | Lignes modifi√©es | Verdict |
|---------|-----------------|---------|
| `mobile/src/components/AlertDialog.tsx` | +1 | ‚úÖ |
| `mobile/src/components/WorkoutExerciseCard.tsx` | +31 / -8 | üî¥ |
| `mobile/src/components/ExerciseTargetInputs.tsx` | +23 / -3 | ‚úÖ |
| `mobile/src/components/CustomModal.tsx` | ~8 tokens | ‚úÖ |
| `mobile/src/components/ExercisePickerModal.tsx` | ~10 tokens | ‚úÖ |
| `mobile/src/components/ErrorBoundary.tsx` | ~14 tokens | ‚úÖ |
| `mobile/src/components/RestTimer.tsx` | ~8 tokens | ‚úÖ |
| `mobile/src/components/SessionExerciseItem.tsx` | ~24 tokens | ‚úÖ |
| `mobile/src/components/SetItem.tsx` | ~8 tokens | ‚úÖ |
| `mobile/src/components/SessionItem.tsx` | ~4 tokens | ‚úÖ |
| `mobile/src/services/ai/aiService.ts` | +5 / -2 | ‚úÖ |
| `mobile/src/screens/AssistantScreen.tsx` | -3 | ‚úÖ |

## Probl√®mes trouv√©s

| # | Fichier | Ligne | Probl√®me | S√©v√©rit√© |
|---|---------|-------|----------|----------|
| 1 | `WorkoutExerciseCard.tsx` | 198 | **Desync local state / validation** : `onValidate` valide `input.weight` et `input.reps` (√©tat parent), mais le TextInput affiche `localWeight`/`localReps`. Si l'utilisateur tape une valeur et tape "valider" avant que le debounce 300ms ne tire, la validation √©choue sur l'ancienne valeur (ex: `""` au lieu de `"100"`). | üî¥ |
| 2 | `WorkoutExerciseCard.tsx` | 50-51 | **Derived state anti-pattern** : `useState(input.weight)` / `useState(input.reps)` n'est initialis√© qu'au mount. Si le parent (withObservables) met √† jour `input` apr√®s le mount, `localWeight`/`localReps` deviennent stale. Dans le cas courant (pre-fill au mount) c'est OK, mais si la DB est modifi√©e concurremment la valeur affich√©e ne se met pas √† jour. | üü° |

## Analyse par commit

### `4680d1e` ‚Äî aiService + AssistantScreen ‚úÖ
- Date filter `Q.where('created_at', Q.gte(thirtyDaysAgo))` : correct, WatermelonDB utilise millisecondes comme `Date.now()`.
- `Q.take(500)` ‚Üí `Q.take(50)` avec filtre 30j : excellente d√©cision perf.
- Suppression `forceUpdate` hack : propre, `withObservables` g√®re la r√©activit√©.

### `d974e11` ‚Äî AlertDialog + debounce + clamping üî¥ (un bug)
- **AlertDialog `haptics.onError()`** : correct, le hook existe (`onError` confirm√© dans `useHaptics.ts:71`).
- **ExerciseTargetInputs clamping** : logique solide. Le cas `value === '.'` est bien g√©r√© (d√©cimal en cours). `parseFloat("50.")` ‚Üí 50 (en range) ‚Üí passe, correct.
- **WorkoutExerciseCard debounce** : timer cleanup via `useEffect` return ‚úÖ, hooks avant return conditionnel ‚úÖ. Mais le bug #1 (validation sur √©tat parent stale) est pr√©sent.

### `b473e24` ‚Äî theme tokens ‚úÖ
- Strat√©gie "token exact uniquement" document√©e et bien appliqu√©e.
- Valeurs non remplac√©es (5, 10, 12, etc.) correctement laiss√©es (pas de token exact).
- Aucun risque de r√©gression visuelle.

## Verdict global : CORRIGE D'ABORD üî¥

Un bug actif dans le flow critique validation de s√©rie (user tape + valide vite ‚Üí validation √©choue).

## Correction requise

### Bug #1 ‚Äî Fix : passer `localWeight`/`localReps` √† `onValidate`

**Option A (recommand√©e)** : Passer la validation dans `WorkoutSetRow` (qui a acc√®s √† `localWeight`/`localReps`) via un callback ref ou en remontant `localWeight` au parent via `onLocalChange`.

**Option B (simple)** : Faire tirer le debounce imm√©diatement au blur/validate plut√¥t qu'apr√®s 300ms ‚Äî utiliser `onBlur` + flush imm√©diat.

**Option C (pragmatique)** : Dans `onValidate`, lire la valeur depuis `localWeight`/`localReps` en passant un getter. N√©cessite de restructurer l√©g√®rement la prop.

## Parall√©lisation des corrections

| # | Probl√®me | Fichiers | Effort | Groupe |
|---|----------|----------|--------|--------|
| 1 | Validation localState desync | `WorkoutExerciseCard.tsx` | ~15min | A |

Un seul fichier, un seul groupe. Pas de parall√©lisation n√©cessaire.

## R√©solution
Rapport do : docs/bmad/do/20260220-2150-fix-workoutexercisecard-validate-desync.md
‚úÖ R√©solu ‚Äî 20260220-2150
