# fix(openaiProvider) — Retry unique sur 429 (rate limit)
Date : 2026-02-21 17:30

## Instruction
docs/bmad/prompts/20260221-1730-warnings-B.md

## Rapport source
docs/bmad/prompts/20260221-1730-warnings-B.md

## Classification
Type : fix
Fichiers modifiés :
- `mobile/src/services/ai/openaiProvider.ts`

## Ce qui a été fait
Dans la méthode `generate` de `createOpenAIProvider`, ajout d'un retry unique sur HTTP 429 :
- Après le premier appel fetch (déjà enveloppé dans try/finally avec `clear()`), on vérifie `response.status === 429`
- Si 429 : attente 1 seconde via `new Promise<void>(r => setTimeout(r, 1000))`
- Création d'un nouveau `withTimeout(30000)` pour le retry
- Second appel fetch dans un bloc try/finally appelant `retry.clear()`
- Le check `response.ok` final reste inchangé — si le retry échoue aussi, le fallback offline de `aiService.ts` prend le relais normalement

Pattern conforme aux contraintes CLAUDE.md §3.1 :
- `withTimeout` de `providerUtils.ts` utilisé (pas de `AbortSignal.timeout()`)
- `clear()` appelé dans `finally` pour chaque `withTimeout`
- `aiService.ts` non modifié

## Vérification
- TypeScript : ✅ zéro erreur (`npx tsc --noEmit`)
- Tests : ✅ 22 passed (`aiService.test.ts`)
- Nouveau test créé : non (comportement couvert par les tests existants de fallback)

## Documentation mise à jour
aucune

## Statut
✅ Résolu — 20260221-1730

## Commit
d7a6868 fix(openaiProvider): retry once on 429 before fallback offline
