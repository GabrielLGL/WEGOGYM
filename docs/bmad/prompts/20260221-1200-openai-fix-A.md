<!-- v1.0 — 2026-02-21 -->
# Rapport — fix OpenAI provider — Groupe A — 20260221-1200

## Objectif
Corriger le provider OpenAI qui retourne une erreur 429 lors du test de connexion.
Deux problèmes à corriger :
1. Modèle obsolète : `gpt-4o-mini` → migrer vers `gpt-4.1-mini` (recommandé OpenAI 2026)
2. Test de connexion trop lourd : actuellement envoie un prompt complet de 2048 tokens → ajouter une fonction `testOpenAIConnection()` minimale (10 tokens max, prompt "Réponds uniquement ok."), sur le modèle de `testGeminiConnection` dans `geminiProvider.ts`

## Fichiers concernés
1. `mobile/src/services/ai/openaiProvider.ts`
2. `mobile/src/services/ai/aiService.ts`

## Contexte technique
- CLAUDE.md §3.1 : Hermes incompatibility → toujours utiliser `withTimeout(ms)` de `providerUtils.ts` (pas `AbortSignal.timeout()`). Appeler `clear()` dans le bloc `finally`.
- Pattern `testGeminiConnection` dans `geminiProvider.ts` : envoie `maxOutputTokens: 10, temperature: 0` avec prompt minimal "Réponds uniquement \"ok\"." — copier exactement ce pattern.
- OpenAI API endpoint : `https://api.openai.com/v1/chat/completions`
- OpenAI auth header : `Authorization: Bearer ${apiKey}`
- `testProviderConnection` dans `aiService.ts` (ligne 125-148) : pour Gemini il appelle `testGeminiConnection(apiKey)` directement. Faire la même chose pour OpenAI avec `testOpenAIConnection`.

## Étapes

### Fichier 1 : `mobile/src/services/ai/openaiProvider.ts`
1. Changer le modèle : `model: 'gpt-4o-mini'` → `model: 'gpt-4.1-mini'`
2. Ajouter la fonction exportée `testOpenAIConnection(apiKey: string): Promise<void>` :
   - Utilise `withTimeout(10000)` (10s, comme Gemini)
   - Envoie `messages: [{ role: 'user', content: 'Réponds uniquement "ok".' }]`
   - `max_tokens: 10, temperature: 0`
   - Si `!response.ok` → throw `new Error(\`OpenAI API erreur \${response.status}\`)`
   - Pas besoin de retourner le contenu

### Fichier 2 : `mobile/src/services/ai/aiService.ts`
1. Importer `testOpenAIConnection` depuis `./openaiProvider` (comme on importe `testGeminiConnection`)
2. Dans `testProviderConnection` (ligne ~131) : ajouter un `if (providerName === 'openai')` qui appelle `testOpenAIConnection(apiKey)` et return — avant le fallback générique

## Contraintes
- Ne pas casser : la méthode `generate()` de `createOpenAIProvider` (hormis le changement de modèle)
- Ne pas casser : `createClaudeProvider` ni aucun autre provider
- Respecter : pattern Hermes `withTimeout` + `finally { clear() }`
- Respecter : TypeScript strict, zéro `any`
- Ne pas modifier : schema, models WatermelonDB, navigation

## Critères de validation
- `npx tsc --noEmit` → zéro erreur
- `npm test` → zéro fail
- `testOpenAIConnection` envoie bien un prompt minimal (10 tokens) et non le prompt complet
- Import de `testOpenAIConnection` dans `aiService.ts` sans erreur TypeScript

## Dépendances
Aucune dépendance externe — peut tourner en parallèle avec Groupe B.

## Statut
⏳ En attente
