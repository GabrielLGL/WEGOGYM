<!-- v1.0 — 2026-02-27 -->
# Rapport — Site Kore audit 2 — Groupe B — 20260227-1500
## Performance & Accessibilité : ScrollReveal no-JS, FOUC thème, SocialProof SSR

## Objectif
Corriger 3 problèmes de qualité dans les composants existants :

1. **ScrollReveal no-JS** : les éléments `.reveal` ont `opacity: 0` en CSS pur. Si JS est désactivé ou lent, tout le contenu des sections Features, Pricing, Subscribe reste invisible. Risque aussi d'être interprété comme "contenu caché" par Google (signal négatif SEO).

2. **FOUC thème** : le `<body>` a `transition: background-color 0.4s ease, color 0.4s ease`. Lors du chargement initial, le script inline dans `<head>` détecte et applique le bon thème AVANT le premier paint — c'est bon. Mais la transition CSS s'applique quand même, causant une animation parasite de 0.4s au premier render sur certains navigateurs.

3. **SocialProof fetch côté client** : actuellement, `SocialProof.tsx` fait un `fetch("/api/subscribers-count")` dans un `useEffect` côté client à chaque visite. Meilleure approche : rendre le composant en Server Component avec ISR (revalidate 3600s) pour éviter la requête client + le flash de loading.

## Fichiers concernés
- `web/src/app/globals.css` — fix FOUC transition + fix reveal no-JS
- `web/src/components/SocialProof.tsx` — convertir en Server Component avec ISR
- `web/src/components/sections/HeroSection.tsx` — retirer `<SocialProof />` client et le remplacer par une version async

## Contexte technique
- Next.js App Router : les Server Components peuvent être `async` et faire des `fetch()` directs avec `next: { revalidate: 3600 }`.
- `HeroSection.tsx` est `"use client"` (animations). Elle ne peut PAS directement importer un Server Component async.
- Solution : créer `SocialProofServer.tsx` (server component) et l'importer dans `HeroSection` via `import dynamic` avec `ssr: false` — non, ça ne marche pas. Meilleure approche : passer le `count` comme prop depuis `page.tsx` (server).
- `page.tsx` est maintenant un Server Component. Il peut faire le fetch et passer le count à HeroSection.
- `BackgroundBlobs.tsx` est un Server Component (pas de "use client") : `position: absolute` dans un parent `relative overflow-hidden`. Le composant parent dans `page.tsx` est `<div className="min-h-screen relative overflow-hidden">`. OK.

### Fix no-JS / ScrollReveal
Stratégie recommandée pour `.reveal` : au lieu d'initialiser à `opacity: 0` dans le CSS global, utiliser une classe CSS ajoutée par JavaScript au `<html>` (via un script inline dans layout.tsx `<head>`). Si JS est absent, les éléments sont visibles par défaut.

```css
/* Avant fix — problématique */
.reveal {
  opacity: 0;
  transform: translateY(40px);
  transition: all 0.8s cubic-bezier(0.5, 0, 0, 1);
}

/* Après fix — visibility par défaut, animation seulement si JS actif */
.js-loaded .reveal {
  opacity: 0;
  transform: translateY(40px);
  transition: all 0.8s cubic-bezier(0.5, 0, 0, 1);
}
.reveal.active {
  opacity: 1;
  transform: translateY(0);
}
```

Et dans `layout.tsx`, ajouter au script inline du head (après le thème) :
```js
document.documentElement.classList.add('js-loaded');
```

### Fix FOUC thème
Ajouter la classe `no-transition` au `<body>` lors du premier chargement, la retirer après :
```css
body.no-transition,
body.no-transition * {
  transition: none !important;
}
```
Dans `layout.tsx` script inline :
```js
document.body.classList.add('no-transition');
requestAnimationFrame(() => requestAnimationFrame(() => {
  document.body.classList.remove('no-transition');
}));
```

### Fix SocialProof ISR
Convertir en Server Component :
```tsx
// web/src/components/SocialProof.tsx — Server Component
import { getSupabase } from "@/lib/supabase";

async function getSubscriberCount(): Promise<number | null> {
  try {
    const supabase = getSupabase();
    const { count } = await supabase
      .from("subscribers")
      .select("*", { count: "exact", head: true });
    return count;
  } catch {
    return null;
  }
}

export default async function SocialProof() {
  const count = await getSubscriberCount();
  // ...render
}
```

Mais attention : `HeroSection` est `"use client"` — elle ne peut PAS importer un Server Component async directement. La solution : passer `count` comme prop depuis `page.tsx`.

Architecture finale :
- `page.tsx` (Server) → fetch count → passe `subscriberCount: number | null` à `<HeroSection>`
- `HeroSection.tsx` (Client) → reçoit `subscriberCount` en prop → l'affiche directement (pas de SocialProof client)
- `SocialProof.tsx` peut être supprimé ou conservé comme composant de présentation simple (sans fetch)

## Étapes

1. **globals.css** :
   - Remplacer `.reveal { opacity: 0 }` par `.js-loaded .reveal { opacity: 0 }`
   - Ajouter `.body.no-transition, .body.no-transition * { transition: none !important }`
   - S'assurer que `@media (prefers-reduced-motion: reduce)` couvre aussi `.js-loaded .reveal`

2. **layout.tsx** — script inline (head) :
   - Après le code de thème, ajouter `document.documentElement.classList.add('js-loaded')`
   - Ajouter la logique `no-transition` sur `document.body`

3. **page.tsx** :
   - Fetch le count Supabase en Server Component (réutiliser la logique de `SocialProof` actuel ou appeler directement l'API `/api/subscribers-count` avec `next: { revalidate: 3600 }`)
   - Passer `subscriberCount` en prop à `HeroSection`

4. **HeroSection.tsx** :
   - Ajouter `subscriberCount: number | null` aux props
   - Remplacer `<SocialProof />` par un affichage inline du count (ou composant de présentation simple)

5. **SocialProof.tsx** :
   - Simplifier en composant de présentation pure (reçoit `count: number | null` en prop, plus de fetch)
   - Retirer `"use client"`, `useEffect`, `useState`

## Contraintes
- Ne pas casser l'animation `.reveal.active` existante
- Ne pas casser la logique de thème du script inline
- Le `<body>` ne doit pas recevoir de `className` dynamique depuis un composant React (le `no-transition` doit être géré par le script inline, pas React)
- TypeScript strict — pas de `any`
- `getSupabase()` est dans `@/lib/supabase`

## Critères de validation
- `npx tsc --noEmit` dans `web/` → zéro erreur
- Désactiver JS dans DevTools → les sections Features/Pricing/Subscribe sont visibles (pas opacity 0)
- Premier chargement → pas de flash de couleur visible au changement de thème
- Network tab → `SocialProof` ne déclenche plus de requête XHR côté client

## Dépendances
Aucune dépendance sur d'autres groupes.

## Statut
✅ Résolu — 20260227-1510

## Résolution
Rapport do : docs/bmad/do/20260227-1510-perf-web-scrollreveal-fouc-ssr.md
