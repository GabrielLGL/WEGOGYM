<!-- v1.0 ‚Äî 2026-02-26 -->
# Rapport ‚Äî Settings Toggle + Navigation ‚Äî Groupe C ‚Äî 20260226

## Objectif
1. Connecter `ThemeProvider` dans `navigation/index.tsx` + charger la pr√©f√©rence sauvegard√©e
2. Ajouter le toggle dark/light dans `SettingsScreen.tsx`

## Fichiers concern√©s
1. `mobile/src/navigation/index.tsx`
2. `mobile/src/screens/SettingsScreen.tsx`

---

## PR√âREQUIS
Le Groupe B doit √™tre termin√© :
- `mobile/src/contexts/ThemeContext.tsx` existe
- `mobile/src/model/schema.ts` est en v23 avec `theme_mode`
- `mobile/src/model/models/User.ts` a `themeMode`

---

## 1. navigation/index.tsx

### Import √† ajouter
```ts
import { ThemeProvider, useTheme } from '../contexts/ThemeContext'
import type { ThemeMode } from '../theme'
```

### Nouveau composant interne `AppWithTheme`

Extraire le contenu de `AppNavigator` dans un composant interne qui peut consommer le ThemeContext :

```tsx
function AppContent() {
  const { colors, mode } = useTheme()
  const navigationRef = useNavigationContainerRef<RootStackParamList>()
  const [initialRoute, setInitialRoute] = useState<keyof RootStackParamList | null>(null)

  // Th√®me Navigation dynamique bas√© sur le mode actif
  const navTheme = {
    ...DarkTheme,
    dark: mode === 'dark',
    colors: {
      ...DarkTheme.colors,
      background: colors.background,
      card: colors.card,
      text: colors.text,
      border: colors.cardSecondary,
      primary: colors.primary,
    },
  }

  useEffect(() => {
    database.get<User>('users').query().fetch().then(users => {
      const user = users[0]
      setInitialRoute(!user || !user.onboardingCompleted ? 'Onboarding' : 'Home')
    })
  }, [])

  if (initialRoute === null) return null

  return (
    <NavigationContainer ref={navigationRef} theme={navTheme}>
      <GlobalBackHandler navigationRef={navigationRef} />
      <Stack.Navigator
        initialRouteName={initialRoute}
        screenOptions={{
          headerStyle: { backgroundColor: colors.background },
          headerTintColor: colors.text,
          headerShadowVisible: false,
          contentStyle: { backgroundColor: colors.background },
          statusBarStyle: mode === 'dark' ? 'light' : 'dark',
          statusBarBackgroundColor: colors.background,
        }}
      >
        {/* ... toutes les Stack.Screen inchang√©es ... */}
      </Stack.Navigator>
    </NavigationContainer>
  )
}
```

### Nouveau `AppNavigator` ‚Äî charge la pr√©f√©rence et fournit le Provider

```tsx
export default function AppNavigator() {
  const [initialMode, setInitialMode] = useState<ThemeMode>('dark')
  const [ready, setReady] = useState(false)

  // Charger la pr√©f√©rence au d√©marrage
  useEffect(() => {
    database.get<User>('users').query().fetch().then(users => {
      const savedMode = users[0]?.themeMode
      if (savedMode === 'light' || savedMode === 'dark') {
        setInitialMode(savedMode)
      }
      setReady(true)
    })
  }, [])

  if (!ready) return null

  return (
    <ErrorBoundary>
      <PortalProvider>
        <ThemeProvider initialMode={initialMode}>
          <AppContent />
        </ThemeProvider>
      </PortalProvider>
    </ErrorBoundary>
  )
}
```

---

## 2. SettingsScreen.tsx

### Imports √† ajouter
```ts
import { useTheme } from '../contexts/ThemeContext'
```

### Dans `SettingsContent`

Ajouter au d√©but du composant :
```tsx
const { mode, toggleTheme, isDark } = useTheme()
```

### Supprimer l'import statique `colors` et utiliser `useTheme`
```ts
// AVANT :
import { colors, spacing, borderRadius, fontSize } from '../theme'

// APR√àS :
import { spacing, borderRadius, fontSize } from '../theme'
import { useTheme } from '../contexts/ThemeContext'
```

Dans le composant :
```tsx
const { colors, mode, isDark, toggleTheme } = useTheme()
```

D√©placer les styles dans la fonction composant (apr√®s le hook useTheme) :
```tsx
const styles = StyleSheet.create({
  container: { flex: 1, backgroundColor: colors.background },
  // ... tous les styles avec colors dynamiques
})
```

### Section Apparence ‚Äî √† ajouter apr√®s "Section Mon profil"

```tsx
{/* Section Apparence */}
<View style={styles.section}>
  <Text style={styles.sectionTitle}>üé® Apparence</Text>
  <View style={styles.settingRow}>
    <View style={styles.settingInfo}>
      <Text style={styles.settingLabel}>Mode {isDark ? 'sombre' : 'clair'}</Text>
      <Text style={styles.settingDescription}>
        {isDark ? 'Neumorphisme dark ‚Äî fond #21242b' : 'Neumorphisme light ‚Äî fond #e8ecef'}
      </Text>
    </View>
    <Switch
      value={isDark}
      onValueChange={async () => {
        haptics.onPress()
        await toggleTheme()
      }}
      trackColor={{ false: colors.cardSecondary, true: colors.primary }}
      thumbColor={colors.text}
    />
  </View>
</View>
```

---

## Contraintes
- `AppContent` doit acc√©der √† `useTheme()` ‚Üí elle doit √™tre ENFANT de `ThemeProvider`
- `AppNavigator` ne peut PAS utiliser `useTheme()` (il fournit le Provider)
- statusBarStyle doit basculer : `'light'` en dark mode, `'dark'` en light mode
- Les styles dans SettingsContent doivent √™tre cr√©√©s DANS le composant (apr√®s les hooks)
  car ils d√©pendent de `colors` dynamiques

## Crit√®res de validation
- `npx tsc --noEmit` ‚Üí z√©ro erreur
- Le toggle dans Settings change l'apparence IMM√âDIATEMENT (pas besoin de reboot)
- Le mode est persist√© : si on ferme/rouvre l'app, le mode est conserv√©
- En light mode : le header change de couleur, le fond de l'app change

## D√©pendances
Groupe B doit √™tre compl√©t√© avant ce groupe.

## Statut
‚è≥ En attente
