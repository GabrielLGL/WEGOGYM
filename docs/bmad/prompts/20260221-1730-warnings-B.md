<!-- v1.0 — 2026-02-21 -->
# Rapport — warnings-dev — Groupe B — 20260221-1730

## Objectif
Améliorer la résilience du provider OpenAI face aux erreurs 429 (rate limit) pour
éviter un fallback offline immédiat sur une erreur transitoire.

Warning actuel :
`[aiService] Provider cloud échoué, fallback offline: [Error: OpenAI API erreur 429]`

## Fichiers concernés
- `mobile/src/services/ai/openaiProvider.ts`
- `mobile/src/services/ai/aiService.ts` (lecture seule — ne pas modifier)

## Contexte technique
- `openaiProvider.ts` lève `new Error('OpenAI API erreur 429')` sur tout statut HTTP non-ok
- `aiService.ts:122` attrape cette erreur et bascule immédiatement sur `offlineEngine`
- Le fallback **fonctionne correctement** — c'est un comportement voulu
- Mais un 429 est transitoire (rate limit) : un retry avec backoff éviterait le fallback inutile
- Contrainte CLAUDE.md §3.1 : utiliser `withTimeout` de `providerUtils.ts` (déjà fait)
- Contrainte CLAUDE.md §3.1 : pas de `AbortSignal.timeout()` (Hermes incompatible)
- Le `console.warn` dans `aiService.ts` est déjà protégé par `__DEV__` — correct

## Étapes
1. Lire `mobile/src/services/ai/openaiProvider.ts` (déjà lu — voir contexte)
2. Lire `mobile/src/services/ai/providerUtils.ts` pour comprendre `withTimeout`
3. Dans `openaiProvider.ts`, dans la méthode `generate`, ajouter un retry unique sur 429 :
   - Si la réponse est 429, attendre 1 seconde (`await new Promise(r => setTimeout(r, 1000))`)
   - Puis refaire l'appel fetch une seule fois avec un nouveau `withTimeout`
   - Si le second appel échoue aussi → throw normalement (le fallback prend le relais)
4. Appliquer le même pattern dans `testOpenAIConnection` si approprié (optionnel)

### Pattern de retry attendu (pseudo-code)
```ts
// Premier appel
response = await fetch(OPENAI_URL, { ..., signal })
// Si 429 → retry once
if (response.status === 429) {
  clear()
  await new Promise(r => setTimeout(r, 1000))
  const retry = withTimeout(30000)
  try {
    response = await fetch(OPENAI_URL, { ..., signal: retry.signal })
  } finally {
    retry.clear()
  }
}
// Vérification finale
if (!response.ok) {
  throw new Error(`OpenAI API erreur ${response.status}`)
}
```

## Contraintes
- `withTimeout` de `providerUtils.ts` DOIT être utilisé — ne pas utiliser `AbortSignal.timeout()`
- Appeler `clear()` dans un bloc `finally` pour chaque `withTimeout`
- Ne pas modifier `aiService.ts` — la logique de fallback reste inchangée
- Ne pas modifier `testOpenAIConnection` si cela ajoute trop de complexité
- Pas de `any` TypeScript
- Pas de `console.log`/`console.warn` sans garde `__DEV__`
- Pas de couleurs hardcodées (pas concerné ici)

## Critères de validation
- `npx tsc --noEmit` → zéro erreur
- `npm test` → zéro fail (vérifier `__tests__/aiService.test.ts`)
- Le warning `[aiService] Provider cloud échoué` disparaît lors d'un 429 transitoire
- Sur 429 persistant (deux tentatives), le fallback offline fonctionne toujours

## Dépendances
Aucune dépendance (groupe indépendant)

## Statut
✅ Résolu — 20260221-1730

## Résolution
Rapport do : docs/bmad/do/20260221-1730-fix-openai-retry-429.md
