# Code Review ‚Äî 20260220-2225

## R√©sultat : 7 probl√®mes trouv√©s

---

### üî¥ Critiques

| # | Fichier | Ligne | Probl√®me | Impact |
|---|---------|-------|----------|--------|
| 1 | `hooks/useSessionManager.ts` | 108, 148, 170, 213 | `console.error` sans guard `__DEV__` (4 occurrences) | Logs techniques expos√©s en production ‚Äî violation CLAUDE.md 3.1 |
| 2 | `hooks/useProgramManager.ts` | 85, 104, 124, 159, 208, 227, 253 | `console.error` sans guard `__DEV__` (7 occurrences) | Logs techniques expos√©s en production ‚Äî violation CLAUDE.md 3.1 |
| 3 | `components/RestTimer.tsx` | 32‚Äì46 | `useEffect` avec deps `[]` r√©f√©rence `notificationEnabled` et `duration` ‚Äî si l'une change apr√®s mount, la notification n'est jamais re-schedul√©e | Bug logique : dur√©e de repos modifiable en settings ‚Üí notification d√©synchronis√©e |

### üü° Warnings

| # | Fichier | Ligne | Probl√®me | Impact |
|---|---------|-------|----------|--------|
| 4 | `components/AlertDialog.tsx` | 146 | `shadowColor: '#000'` hardcod√© ‚Äî violation CLAUDE.md 3.1 | Incoh√©rence theme, dark mode futur |
| 4 | `components/BottomSheet.tsx` | 137 | `shadowColor: '#000'` hardcod√© | Idem |
| 4 | `components/CustomModal.tsx` | 87 | `shadowColor: '#000'` hardcod√© | Idem |
| 4 | `screens/HomeScreen.tsx` | 389 | `shadowColor: '#000'` hardcod√© | Idem |
| 5 | `model/utils/databaseHelpers.ts` | 454, 602, 727 | `exercises.query().fetch()` sans `Q.where` ‚Äî charge TOUTE la table `exercises` pour matcher par nom en JS | Performance d√©grad√©e lin√©airement avec le nombre d'exercices import√©s |

### üîµ Suggestions

| # | Fichier | Ligne | Probl√®me | Suggestion |
|---|---------|-------|----------|------------|
| 6 | Multiple screens | ‚Äî | `users.query().observe().pipe(map(l => l[0]))` r√©p√©t√© dans 5+ screens via `withObservables` | Centraliser dans un helper `observeUser()` dans `databaseHelpers.ts` |
| 7 | `screens/SessionDetailScreen.tsx` | 122‚Äì145 | `DraggableFlatList` sans `windowSize`, `maxToRenderPerBatch` | Ajouter pour grandes listes (>20 exercices) |

---

### D√©tail probl√®me #3 ‚Äî RestTimer useEffect manque ses d√©pendances

```tsx
// ‚ùå ACTUEL (RestTimer.tsx:32‚Äì46)
useEffect(() => {
  if (notificationEnabled) {
    scheduleRestEndNotification(duration) // ‚Üê r√©f√©renc√© mais pas en dep
      .then(id => { notificationIdRef.current = id })
      .catch(...)
  }
  return () => { cancelNotification(notificationIdRef.current) }
}, [])  // ‚Üê VIDE ‚Äî bug si duration ou notificationEnabled change apr√®s mount

// ‚úÖ CORRECT
}, [duration, notificationEnabled])
// Note : le cleanup annulera et re-schedulera si l'une des deps change
```

**Sc√©nario de bug** : l'utilisateur modifie la dur√©e de repos dans les Settings (SettingsScreen) ‚Üí la valeur `notificationEnabled` reste stable mais `duration` change ‚Üí RestTimer d√©j√† mont√© avec l'ancienne valeur ‚Üí notification arrive √† la mauvaise heure.

---

### D√©tail probl√®me #1 & #2 ‚Äî console.error non gard√©

```tsx
// ‚ùå ACTUEL (useSessionManager.ts:108)
} catch (error) {
  console.error('Failed to add exercise:', error)
  return false
}

// ‚úÖ CORRECT
} catch (error) {
  if (__DEV__) console.error('[useSessionManager] addExercise failed:', error)
  return false
}
```

11 occurrences au total : 4 dans `useSessionManager.ts`, 7 dans `useProgramManager.ts`.

---

### D√©tail probl√®me #5 ‚Äî Query sans filtre

```tsx
// ‚ùå ACTUEL (databaseHelpers.ts:454, 602, 727)
const exercises = await database.get<Exercise>('exercises').query().fetch()
// ‚Üí charge TOUTES les lignes en m√©moire, filtre en JS ensuite

// ‚úÖ ID√âAL si nom connu d'avance
const exercises = await database.get<Exercise>('exercises')
  .query(Q.where('name', Q.oneOf(exerciseNames)))
  .fetch()
// Note : requiert de conna√Ætre les noms √† l'avance ‚Äî refactor partiel possible
```

Les 3 occurrences sont dans des fonctions d'import (`importPresetProgram`, `importGeneratedPlan`, `importGeneratedSession`) qui ont besoin de matcher des exercices par nom. Un filtre `Q.oneOf` sur les noms attendus r√©duirait drastiquement la charge.

---

## Parall√©lisation des corrections

| # | Probl√®me | Fichiers | Effort | Groupe |
|---|----------|----------|--------|--------|
| 1+2 | console.error sans __DEV__ | `useSessionManager.ts`, `useProgramManager.ts` | 15 min | **A** |
| 3 | RestTimer useEffect deps | `components/RestTimer.tsx` | 10 min | **B** |
| 4 | shadowColor '#000' hardcod√© | `AlertDialog.tsx`, `BottomSheet.tsx`, `CustomModal.tsx`, `HomeScreen.tsx` | 10 min | **C** |
| 5 | Query sans WHERE (import functions) | `model/utils/databaseHelpers.ts` | 30 min | **D** |
| 6+7 | Suggestions (observeUser, FlatList) | Multiple | 45 min | Backlog |

Groupes A, B, C, D ‚Üí parall√®le (fichiers diff√©rents)

## R√©solution
‚úÖ R√©solu ‚Äî 20260220-2300
Rapport do : docs/bmad/do/20260220-2300-fix-code-review-2225.md
