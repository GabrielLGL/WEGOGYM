# Code Review ‚Äî 20260221-0229

## R√©sultat : 10 probl√®mes trouv√©s

---

### üî¥ Critiques

| # | Fichier | Ligne | Probl√®me | Impact |
|---|---------|-------|----------|--------|
| 1 | `hooks/useProgramManager.ts` | 143‚Äì145, 174‚Äì176 | `getNextPosition()` appel√© **√† l'int√©rieur** d'un bloc `database.write()` ‚Äî la fonction ex√©cute un `.fetchCount()` (requ√™te lecture) dans une transaction d'√©criture, ce que WatermelonDB interdit selon sa doc (reads inside write transactions = undefined behavior) | Corruption silencieuse de position, crash potentiel |
| 2 | `hooks/useExerciseManager.ts` + `useSessionManager.ts` + `useProgramManager.ts` | ~63, ~75, ~85 | `validateXxx()` retourne `{ valid, errors }` mais seul `.valid` est consomm√© ‚Äî `.errors` est ignor√©. L'utilisateur ne re√ßoit aucun feedback quand la validation √©choue (`return false` silencieux) | UX cass√©e : l'utilisateur ne sait pas pourquoi le bouton ne r√©pond pas |

---

### üü° Warnings

| # | Fichier | Ligne | Probl√®me | Impact |
|---|---------|-------|----------|--------|
| 3 | `model/models/Program.ts` L16, `Session.ts` L20, `History.ts` L18, `Exercise.ts` L14-16 | ‚Äî | Aucun `@lazy` sur les relations `@children` lourdes (`sessions`, `sessionExercises`, `sets`, `performanceLogs`). Sur une liste de 10 programs √ó 5 sessions = 50 requ√™tes automatiques en chargeant la HomeScreen | N+1 queries, freeze UI sur Android |
| 4 | `screens/AssistantScreen.tsx` | 187‚Äì189 | `buildSteps(formData)` appel√© **√† chaque render** sans `useMemo`. La fonction est une cascade de conditions sur plusieurs types de step ‚Äî re-calcul complet √† chaque keystroke ou state change mineur | Re-renders co√ªteux dans le wizard IA |
| 5 | `screens/HomeScreen.tsx` | 204‚Äì216 | Callback async complexe `onDragEnd` d√©clar√© inline dans `DraggableFlatList` (10 lignes, `database.write()` inclus). Recr√©√© √† chaque render, invalide la m√©morisation du composant enfant | Re-renders DraggableFlatList inutiles pendant les drags |
| 6 | `screens/ExercisesScreen.tsx` L177‚Äì202, `screens/ChartsScreen.tsx` L123‚Äì152, `screens/WorkoutScreen.tsx` L182‚Äì201 | ‚Äî | Trois `FlatList` sans `getItemLayout`, `windowSize`, ni `maxToRenderPerBatch`. Les hauteurs d'items sont fixes dans ces listes | Scroll janky sur Android, recalcul layout √† chaque scroll event |
| 7 | `screens/AssistantScreen.tsx` | 1‚Äì822 | Fichier 822 lignes. `AssistantScreenInner` = 447 lignes. `renderStepContent()` = 154 lignes avec 5 blocs `if (step.kind === ...)` imbriqu√©s (devrait √™tre un `switch` ou des composants s√©par√©s par `kind`) | Maintenabilit√© nulle, impossible √† tester unitairement |
| 8 | `screens/SettingsScreen.tsx` | 27, 35 | Cast `as AIProviderName` sans validation runtime : `(user?.aiProvider as AIProviderName) ?? 'offline'`. Si la DB contient une valeur corrompue/ancienne, le type est faux et peut provoquer un crash aval dans le provider IA | Bug silencieux si valeur DB invalide |

---

### üîµ Suggestions

| # | Fichier | Ligne | Probl√®me | Suggestion |
|---|---------|-------|----------|------------|
| 9 | `screens/ChartsScreen.tsx` | 277‚Äì278 | Couleurs hardcod√©es dans `chartConfig` : `rgba(0, 122, 255, ${opacity})` et `rgba(255, 255, 255, ${opacity})` ‚Äî viole la r√®gle "No hardcoded colors" de CLAUDE.md | Utiliser `colors.primary` et `colors.text` avec `hexToRgba()` ou un helper similaire |
| 10 | `hooks/useSessionManager.ts` | 126‚Äì131 | `repsVal` pars√© en int (ligne 126 : `parseIntegerInput(targetReps)`) puis **jamais utilis√©** ‚Äî `se.repsTarget = targetReps` (string) √† la ligne 131. Dead code trompeur qui laisse croire √† une incoh√©rence de type | Supprimer `repsVal` ou l'utiliser ; ajouter un commentaire explicatif si le string est intentionnel |

---

## Parall√©lisation des corrections

| # | Probl√®me | Fichiers touch√©s | Effort | Groupe |
|---|----------|-----------------|--------|--------|
| 1 | `getNextPosition()` hors `write()` | `hooks/useProgramManager.ts` | 15 min | **A** |
| 2 | Surfacer `validation.errors` | `hooks/useExerciseManager.ts`, `useSessionManager.ts`, `useProgramManager.ts` | 30 min | **A** |
| 10 | Dead code `repsVal` | `hooks/useSessionManager.ts` | 5 min | **A** |
| 3 | `@lazy` sur relations | `model/models/Program.ts`, `Session.ts`, `History.ts`, `Exercise.ts` | 20 min | **B** |
| 4 | `useMemo` buildSteps | `screens/AssistantScreen.tsx` | 10 min | **C** |
| 5 | `useCallback` onDragEnd | `screens/HomeScreen.tsx` | 10 min | **D** |
| 6 | `getItemLayout` FlatLists | `screens/ExercisesScreen.tsx`, `ChartsScreen.tsx`, `WorkoutScreen.tsx` | 20 min | **D** |
| 7 | D√©coupage AssistantScreen | `screens/AssistantScreen.tsx` | 45 min | **C** |
| 8 | Runtime validation `AIProviderName` | `screens/SettingsScreen.tsx` | 10 min | **E** |
| 9 | Couleurs chartConfig ‚Üí theme | `screens/ChartsScreen.tsx` | 5 min | **F** |

**Groupes :**
- M√™me lettre = m√™mes fichiers (s√©quentiel obligatoire)
- Lettres diff√©rentes = parall√©lisable
- **Claude Code 1** : Groupe A (critical hooks)
- **Claude Code 2** : Groupe B (models @lazy)
- **Claude Code 3** : Groupes C+D (screens performance)
- **Claude Code 4** : Groupes E+F (rapides)
