# CohÃ©rence WatermelonDB â€” 20260220-2235

## RÃ©sultat : âœ… CohÃ©rent â€” 1 doc mismatch / 1 note architecture

---

### SchÃ©ma â†” ModÃ¨les

| Table | Colonnes schÃ©ma | DÃ©corateurs modÃ¨le | Statut |
|-------|-----------------|-------------------|--------|
| `programs` | name, position, created_at, updated_at | @field name, position / @date created_at, updated_at | âœ… |
| `sessions` | program_id, name, position, created_at, updated_at, deleted_at | @field name, position / @relation program_id / @date created_at, updated_at, deleted_at | âœ… |
| `session_exercises` | session_id, exercise_id, position, sets_target, reps_target, weight_target, created_at, updated_at | @field position, sets_target, reps_target, weight_target / @relation session_id, exercise_id / @date created_at, updated_at | âœ… |
| `exercises` | name, is_custom, muscles, equipment, created_at, updated_at | @text name, muscles, equipment / @field is_custom / @date created_at, updated_at | âœ… |
| `performance_logs` | exercise_id, sets, weight, reps, created_at | @field sets, weight, reps / @relation exercise_id / @date created_at | âœ… (pas d'updated_at intentionnel) |
| `users` | email, timer_enabled, rest_duration, onboarding_completed, ai_provider, ai_api_key, created_at, updated_at | @text email, ai_provider, ai_api_key / @field timer_enabled, rest_duration, onboarding_completed / @date created_at, updated_at | âœ… |
| `histories` | session_id, start_time, end_time, note, created_at, updated_at, deleted_at | @date start_time, end_time, created_at, updated_at, deleted_at / @text note / @relation session_id | âœ… |
| `sets` | history_id, exercise_id, weight, reps, set_order, is_pr, created_at, updated_at | @field weight, reps, set_order, is_pr / @relation history_id, exercise_id / @date created_at, updated_at | âœ… |

**Aucune colonne orpheline. Aucun dÃ©corateur sans colonne.**

---

### Relations

| ModÃ¨le | Relation | FK / Table cible | Statut |
|--------|----------|-----------------|--------|
| `Program` | @children('sessions') | program_id â†’ sessions | âœ… |
| `Session` | @relation('programs', 'program_id') | programs âœ… |
| `Session` | @children('histories') | session_id â†’ histories | âœ… |
| `Session` | @children('session_exercises') | session_id â†’ session_exercises | âœ… |
| `SessionExercise` | @relation('sessions', 'session_id') | sessions âœ… |
| `SessionExercise` | @relation('exercises', 'exercise_id') | exercises âœ… |
| `History` | @relation('sessions', 'session_id') | sessions âœ… |
| `History` | @children('sets') | history_id â†’ sets | âœ… |
| `Set` | @relation('histories', 'history_id') | histories âœ… |
| `Set` | @relation('exercises', 'exercise_id') | exercises âœ… |
| `PerformanceLog` | @relation('exercises', 'exercise_id') | exercises âœ… |

**Aucune relation orpheline.**

---

### IncohÃ©rences trouvÃ©es

| # | Fichier | Type | Description |
|---|---------|------|-------------|
| 1 | `CLAUDE.md:20,46` | Doc mismatch | CLAUDE.md documente **Schema v15** mais `schema.ts` est en **version 16** (ajout ai_provider + ai_api_key). Risque : documentation trompeuse pour les futurs dÃ©veloppeurs. |
| 2 | `Program.ts:12` | CosmÃ©tique | `@field('name')` pour une colonne string au lieu de `@text('name')`. Tous les autres modÃ¨les (User, Exercise, History) utilisent `@text` pour les strings. Fonctionnellement Ã©quivalent, mais incohÃ©rent. |

---

### Migrations

**Pas de fichier migrations.** `SQLiteAdapter` est configurÃ© sans `migrations:` (`model/index.ts:14`).

Comportement WatermelonDB sans migrations :
- Si la version de schema change (ex: v15 â†’ v16), la DB est **dÃ©truite et recrÃ©Ã©e** (toutes les donnÃ©es perdues).
- Ce pattern est acceptable en dÃ©veloppement / early stage, mais doit Ãªtre rÃ©solu avant release si des utilisateurs ont dÃ©jÃ  des donnÃ©es.

**Recommandation** : Si la v16 est dÃ©jÃ  en production, un fichier `migrations.ts` doit Ãªtre crÃ©Ã© avec une migration v15â†’v16 ajoutant les colonnes `ai_provider` et `ai_api_key` Ã  la table `users`.

---

## Corrections recommandÃ©es

| # | ProblÃ¨me | Effort | PrioritÃ© |
|---|----------|--------|----------|
| 1 | Mettre Ã  jour CLAUDE.md "v15" â†’ "v16" | 1 min | ðŸŸ¡ Documentation |
| 2 | `Program.@field('name')` â†’ `@text('name')` | 1 min | ðŸ”µ CosmÃ©tique |
| 3 | CrÃ©er `migrations.ts` v15â†’v16 (si prod) | 20 min | ðŸŸ¡ Si prod |
