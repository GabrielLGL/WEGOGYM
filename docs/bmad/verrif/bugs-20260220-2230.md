# Bugs silencieux â€” 20260220-2230

## RÃ©sumÃ© : ðŸ”´ 1 critique / ðŸŸ¡ 2 warnings / ðŸ”µ 1 note

---

### Critiques

| Fichier | Ligne | Type | Description |
|---------|-------|------|-------------|
| `model/utils/databaseHelpers.ts` | 304â€“314 | Unhandled rejection + crash potentiel | `Promise.all` avec `.find()` sans try/catch â†’ throw si une history est physiquement supprimÃ©e (RecordNotFound) â†’ propagation jusqu'Ã  `WorkoutExerciseCard:244` via `from()` RxJS â†’ crash composant. De plus, si l'array `histories` est vide, `[0]` retourne `undefined` et l'accÃ¨s `.id` ligne 314 crashe. |

#### DÃ©tail du bug critique

```typescript
// databaseHelpers.ts:303â€“314
const histories = await Promise.all(
  historyIds.map(id => database.get<History>('histories').find(id))
  // â†‘ .find() THROWS RecordNotFound si l'ID n'existe pas
  // â†‘ Pas de try/catch autour du Promise.all
)

const mostRecent = histories.sort(
  (a, b) => b.startTime.getTime() - a.startTime.getTime()
)[0]  // â† histories potentiellement vide â†’ undefined

const recentSets = sets.filter(s => s.history.id === mostRecent.id)
// â†‘ mostRecent peut Ãªtre undefined â†’ CRASH runtime
```

**ChaÃ®ne d'appel :** `getLastPerformanceForExercise` â†’ `WorkoutExerciseCard:244` â†’ `from(...)` RxJS â†’ `withObservables` HOC â†’ crash component non catchable.

**ScÃ©nario rÃ©el :** Un set rÃ©fÃ©rence une history qui a Ã©tÃ© `destroyPermanently()` (via un bug passÃ© ou migration) â†’ `find(id)` throw `RecordNotFound` â†’ le composant crash pendant la sÃ©ance â†’ l'entraÃ®nement est perdu.

**Fix :**
```typescript
// Remplacer Promise.all + .find() par une query filtrÃ©e
const histories = await database
  .get<History>('histories')
  .query(Q.where('id', Q.oneOf(historyIds)))
  .fetch()

if (histories.length === 0) return null  // Guard obligatoire

const mostRecent = histories.sort(
  (a, b) => b.startTime.getTime() - a.startTime.getTime()
)[0]
```

---

### Warnings

| Fichier | Ligne | Type | Description |
|---------|-------|------|-------------|
| `hooks/useWorkoutState.ts` | 53â€“69 | Deps useEffect volontairement vides | `useEffect(() => {...}, [])` avec `// eslint-disable-next-line` â€” `sessionExercises` closed-in au mount uniquement. Si le component re-mount avec de nouveaux exercises, les inputs ne se rÃ©initialisent pas. Volontaire mais fragile. |
| `screens/WorkoutScreen.tsx` | 97â€“103 | Erreur async silencieuse prod | `createWorkoutHistory` Ã©choue â†’ `.catch` log seulement en `__DEV__` â†’ `historyId` reste `''` â†’ guard `if (!historyId) return false` dans `validateSet` empÃªche les saves â†’ UI bloquÃ©e sans feedback utilisateur |

#### DÃ©tail warning #2 â€” WorkoutScreen createWorkoutHistory

```typescript
// WorkoutScreen.tsx:97â€“103
createWorkoutHistory(session.id, startTimestampRef.current)
  .then(history => {
    historyRef.current = history
    setHistoryId(history.id)
  })
  .catch(e => { if (__DEV__) console.error('[WorkoutScreen] createWorkoutHistory:', e) })
  // â†‘ En PROD : erreur silencieuse â†’ historyId = '' â†’ validateSet bloquÃ© sans feedback

// Fix recommandÃ© : afficher une alerte ou toast Ã  l'utilisateur si la crÃ©ation Ã©choue
```

---

### Note

| Fichier | Ligne | Type | Description |
|---------|-------|------|-------------|
| `services/notificationService.ts` | 7â€“14 | require() silencieux | `require('expo-notifications')` dans try/catch retourne null sans log si le module manque en DEV â€” comportement notification absent sans diagnostic |

---

## ParallÃ©lisation des corrections

| # | ProblÃ¨me | Fichiers | Effort | Groupe |
|---|----------|----------|--------|--------|
| 1 | Promise.all + .find() â†’ query filtrÃ©e + guard [0] | `model/utils/databaseHelpers.ts` | 15 min | **A** |
| 2 | WorkoutScreen createWorkoutHistory feedback utilisateur | `screens/WorkoutScreen.tsx` | 10 min | **B** |
| 3 | useWorkoutState deps (documenter l'intention) | `hooks/useWorkoutState.ts` | 5 min | **C** |

Groupes A, B, C â†’ parallÃ¨le (fichiers diffÃ©rents)

---

## RÃ©solution
âœ… RÃ©solu â€” 20260220-2240
Rapport do : docs/bmad/do/20260220-2240-fix-databaseHelpers-WorkoutScreen.md
